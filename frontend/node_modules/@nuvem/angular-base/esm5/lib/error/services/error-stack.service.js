import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { ReplaySubject } from 'rxjs';
import { HttpGenericErrorService } from '../services/http-generic-error.service';
import * as i0 from "@angular/core";
import * as i1 from "./http-generic-error.service";
/**
 * Serviço de erros ErrorStackService
 * @class
 */
var ErrorStackService = /** @class */ (function () {
    /**
     * metodo construtor injeta serviço generico de erros
     * @param {HttpGenericErrorService} genericErrorService
     * @constructor
     */
    function ErrorStackService(genericErrorService) {
        var _this = this;
        this.genericErrorService = genericErrorService;
        /**
         * Propriedade errors
         * @type {ReplaySubject<NamedErrorType>}
         */
        this.errors = new ReplaySubject();
        if (null === localStorage.getItem('errorStack')) {
            localStorage.setItem('errorStack', JSON.stringify([]));
        }
        this.getErrorsSubjects().forEach(function (error) {
            _this.errors.next(error);
        });
    }
    /**
     * Metodo responsável por criar erro do tipo HttpResponse
     * @param {HttpErrorResponse} error
     * @returns void
     */
    ErrorStackService.prototype.create = function (error) {
        var namedError = this.createNamedError(error);
        var persistedErrors = this.getErrorsSubjects();
        if (persistedErrors.length >= 15) {
            persistedErrors.shift();
        }
        persistedErrors.push(namedError);
        localStorage.setItem('errorStack', JSON.stringify(persistedErrors));
        this.errors.next(namedError);
    };
    /**
     * Metodo responsável por obter o conteúdo dos erros emitidos
     * @private
     * @returns NamedErrorType[]
     */
    ErrorStackService.prototype.getErrorsSubjects = function () {
        return JSON.parse(localStorage.getItem('errorStack'));
    };
    /**
     * Metodo responsável por itentifica o tipo de erro lançado
     * @private
     * @param {HttpErrorResponse} error
     * @returns NamedErrorType
     */
    ErrorStackService.prototype.createNamedError = function (error) {
        var fullMessage;
        var namedError;
        var createdAt = new Date();
        var errorId = this.getErrorId(error);
        var title;
        if (error.headers.get('Content-Type') === 'application/problem+json') {
            fullMessage = "X-Correlation-ID: " + errorId + "\n                           createdAt: " + createdAt + "\n                           status: " + error.status + "\n                           url: " + error.url + "\n                           body: " + error.error.detail + "\n                           stacktrace: " + error.error.stacktrace + "\n                           cause: " + error.error.cause;
            title = error.error.title;
        }
        else {
            var genericError = this.genericErrorService.getErrorByCode(error);
            fullMessage = "X-Correlation-ID: " + errorId + "\n                           createdAt: " + createdAt + "\n                           status: " + error.status + "\n                           url: " + error.url + "\n                           body: " + genericError.detail;
            title = genericError.title;
        }
        namedError = {
            message: title,
            createdAt: createdAt,
            correlationId: errorId,
            fullMessage: fullMessage
        };
        return namedError;
    };
    /**
     * Metodo responsável por obter o identificador do erro
     * @private
     * @param {HttpErrorResponse} error
     * @returns string
     */
    ErrorStackService.prototype.getErrorId = function (error) {
        var errorKey;
        error.headers.keys().every(function (key) {
            if (key.toUpperCase() === 'X-CORRELATION-ID') {
                errorKey = key;
                return false;
            }
            return true;
        });
        return errorKey ? error.headers.get(errorKey) : null;
    };
    ErrorStackService.ctorParameters = function () { return [
        { type: HttpGenericErrorService }
    ]; };
    ErrorStackService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ErrorStackService_Factory() { return new ErrorStackService(i0.ɵɵinject(i1.HttpGenericErrorService)); }, token: ErrorStackService, providedIn: "root" });
    ErrorStackService = __decorate([
        Injectable({
            providedIn: 'root',
        })
    ], ErrorStackService);
    return ErrorStackService;
}());
export { ErrorStackService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3Itc3RhY2suc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BudXZlbS9hbmd1bGFyLWJhc2UvIiwic291cmNlcyI6WyJsaWIvZXJyb3Ivc2VydmljZXMvZXJyb3Itc3RhY2suc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBR3JDLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDOzs7QUFFakY7OztHQUdHO0FBSUg7SUFRSTs7OztPQUlHO0lBQ0gsMkJBQW9CLG1CQUE0QztRQUFoRSxpQkFRQztRQVJtQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXlCO1FBWGhFOzs7V0FHRztRQUNILFdBQU0sR0FBa0MsSUFBSSxhQUFhLEVBQWtCLENBQUM7UUFReEUsSUFBSSxJQUFJLEtBQUssWUFBWSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRTtZQUM3QyxZQUFZLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDMUQ7UUFFRCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBQyxLQUFxQjtZQUNuRCxLQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsa0NBQU0sR0FBTixVQUFPLEtBQXdCO1FBQzNCLElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVoRCxJQUFNLGVBQWUsR0FBcUIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFFbkUsSUFBSSxlQUFlLENBQUMsTUFBTSxJQUFJLEVBQUUsRUFBRTtZQUM5QixlQUFlLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDM0I7UUFFRCxlQUFlLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRWpDLFlBQVksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztRQUVwRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNLLDZDQUFpQixHQUF6QjtRQUNJLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssNENBQWdCLEdBQXhCLFVBQXlCLEtBQXdCO1FBQzdDLElBQUksV0FBbUIsQ0FBQztRQUN4QixJQUFJLFVBQTBCLENBQUM7UUFDL0IsSUFBSSxTQUFTLEdBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNqQyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JDLElBQUksS0FBb0IsQ0FBQztRQUV6QixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxLQUFLLDBCQUEwQixFQUFFO1lBQ2xFLFdBQVcsR0FBRyx1QkFBcUIsT0FBTyxnREFDZCxTQUFTLDZDQUNaLEtBQUssQ0FBQyxNQUFNLDBDQUNmLEtBQUssQ0FBQyxHQUFHLDJDQUNSLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxpREFDWixLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsNENBQzNCLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBTyxDQUFDO1lBRTVDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztTQUU3QjthQUFNO1lBQ0gsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVwRSxXQUFXLEdBQUcsdUJBQXFCLE9BQU8sZ0RBQ2QsU0FBUyw2Q0FDWixLQUFLLENBQUMsTUFBTSwwQ0FDZixLQUFLLENBQUMsR0FBRywyQ0FDUixZQUFZLENBQUMsTUFBUSxDQUFDO1lBRTdDLEtBQUssR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1NBQzlCO1FBRUQsVUFBVSxHQUFHO1lBQ1QsT0FBTyxFQUFFLEtBQUs7WUFDZCxTQUFTLEVBQUUsU0FBUztZQUNwQixhQUFhLEVBQUUsT0FBTztZQUN0QixXQUFXLEVBQUUsV0FBVztTQUMzQixDQUFDO1FBRUYsT0FBTyxVQUFVLENBQUM7SUFDdEIsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssc0NBQVUsR0FBbEIsVUFBbUIsS0FBd0I7UUFDdkMsSUFBSSxRQUF1QixDQUFDO1FBRTVCLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQUEsR0FBRztZQUMxQixJQUFJLEdBQUcsQ0FBQyxXQUFXLEVBQUUsS0FBSyxrQkFBa0IsRUFBRTtnQkFDMUMsUUFBUSxHQUFHLEdBQUcsQ0FBQztnQkFDZixPQUFPLEtBQUssQ0FBQzthQUNoQjtZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDekQsQ0FBQzs7Z0JBeEd3Qyx1QkFBdUI7OztJQWJ2RCxpQkFBaUI7UUFIN0IsVUFBVSxDQUFDO1lBQ1IsVUFBVSxFQUFFLE1BQU07U0FDckIsQ0FBQztPQUNXLGlCQUFpQixDQXVIN0I7NEJBcElEO0NBb0lDLEFBdkhELElBdUhDO1NBdkhZLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJlcGxheVN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE5hbWVkRXJyb3JUeXBlIH0gZnJvbSAnLi4vdHlwZXMvbmFtZWQtZXJyb3IudHlwZSc7XG5pbXBvcnQgeyBIdHRwRXJyb3JSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEh0dHBHZW5lcmljRXJyb3JTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvaHR0cC1nZW5lcmljLWVycm9yLnNlcnZpY2UnO1xuXG4vKipcbiAqIFNlcnZpw6dvIGRlIGVycm9zIEVycm9yU3RhY2tTZXJ2aWNlXG4gKiBAY2xhc3MgXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIEVycm9yU3RhY2tTZXJ2aWNlIHtcblxuICAgIC8qKlxuICAgICAqIFByb3ByaWVkYWRlIGVycm9yc1xuICAgICAqIEB0eXBlIHtSZXBsYXlTdWJqZWN0PE5hbWVkRXJyb3JUeXBlPn1cbiAgICAgKi9cbiAgICBlcnJvcnM6IFJlcGxheVN1YmplY3Q8TmFtZWRFcnJvclR5cGU+ID0gbmV3IFJlcGxheVN1YmplY3Q8TmFtZWRFcnJvclR5cGU+KCk7XG5cbiAgICAvKipcbiAgICAgKiBtZXRvZG8gY29uc3RydXRvciBpbmpldGEgc2VydmnDp28gZ2VuZXJpY28gZGUgZXJyb3NcbiAgICAgKiBAcGFyYW0ge0h0dHBHZW5lcmljRXJyb3JTZXJ2aWNlfSBnZW5lcmljRXJyb3JTZXJ2aWNlXG4gICAgICogQGNvbnN0cnVjdG9yXG4gICAgICovXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBnZW5lcmljRXJyb3JTZXJ2aWNlOiBIdHRwR2VuZXJpY0Vycm9yU2VydmljZSkge1xuICAgICAgICBpZiAobnVsbCA9PT0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2Vycm9yU3RhY2snKSkge1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2Vycm9yU3RhY2snLCBKU09OLnN0cmluZ2lmeShbXSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5nZXRFcnJvcnNTdWJqZWN0cygpLmZvckVhY2goKGVycm9yOiBOYW1lZEVycm9yVHlwZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lcnJvcnMubmV4dChlcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE1ldG9kbyByZXNwb25zw6F2ZWwgcG9yIGNyaWFyIGVycm8gZG8gdGlwbyBIdHRwUmVzcG9uc2VcbiAgICAgKiBAcGFyYW0ge0h0dHBFcnJvclJlc3BvbnNlfSBlcnJvclxuICAgICAqIEByZXR1cm5zIHZvaWRcbiAgICAgKi9cbiAgICBjcmVhdGUoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IG5hbWVkRXJyb3IgPSB0aGlzLmNyZWF0ZU5hbWVkRXJyb3IoZXJyb3IpO1xuXG4gICAgICAgIGNvbnN0IHBlcnNpc3RlZEVycm9yczogTmFtZWRFcnJvclR5cGVbXSA9IHRoaXMuZ2V0RXJyb3JzU3ViamVjdHMoKTtcblxuICAgICAgICBpZiAocGVyc2lzdGVkRXJyb3JzLmxlbmd0aCA+PSAxNSkge1xuICAgICAgICAgICAgcGVyc2lzdGVkRXJyb3JzLnNoaWZ0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBwZXJzaXN0ZWRFcnJvcnMucHVzaChuYW1lZEVycm9yKTtcblxuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZXJyb3JTdGFjaycsIEpTT04uc3RyaW5naWZ5KHBlcnNpc3RlZEVycm9ycykpO1xuXG4gICAgICAgIHRoaXMuZXJyb3JzLm5leHQobmFtZWRFcnJvcik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWV0b2RvIHJlc3BvbnPDoXZlbCBwb3Igb2J0ZXIgbyBjb250ZcO6ZG8gZG9zIGVycm9zIGVtaXRpZG9zXG4gICAgICogQHByaXZhdGVcbiAgICAgKiBAcmV0dXJucyBOYW1lZEVycm9yVHlwZVtdXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRFcnJvcnNTdWJqZWN0cygpOiBOYW1lZEVycm9yVHlwZVtdIHtcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2Vycm9yU3RhY2snKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTWV0b2RvIHJlc3BvbnPDoXZlbCBwb3IgaXRlbnRpZmljYSBvIHRpcG8gZGUgZXJybyBsYW7Dp2Fkb1xuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIHtIdHRwRXJyb3JSZXNwb25zZX0gZXJyb3JcbiAgICAgKiBAcmV0dXJucyBOYW1lZEVycm9yVHlwZVxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlTmFtZWRFcnJvcihlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpOiBOYW1lZEVycm9yVHlwZSB7XG4gICAgICAgIGxldCBmdWxsTWVzc2FnZTogc3RyaW5nO1xuICAgICAgICBsZXQgbmFtZWRFcnJvcjogTmFtZWRFcnJvclR5cGU7XG4gICAgICAgIGxldCBjcmVhdGVkQXQ6IERhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICBsZXQgZXJyb3JJZCA9IHRoaXMuZ2V0RXJyb3JJZChlcnJvcik7XG4gICAgICAgIGxldCB0aXRsZTogc3RyaW5nIHwgbnVsbDtcblxuICAgICAgICBpZiAoZXJyb3IuaGVhZGVycy5nZXQoJ0NvbnRlbnQtVHlwZScpID09PSAnYXBwbGljYXRpb24vcHJvYmxlbStqc29uJykge1xuICAgICAgICAgICAgZnVsbE1lc3NhZ2UgPSBgWC1Db3JyZWxhdGlvbi1JRDogJHtlcnJvcklkfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlZEF0OiAke2NyZWF0ZWRBdH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogJHtlcnJvci5zdGF0dXN9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6ICR7ZXJyb3IudXJsfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9keTogJHtlcnJvci5lcnJvci5kZXRhaWx9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFja3RyYWNlOiAke2Vycm9yLmVycm9yLnN0YWNrdHJhY2V9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBjYXVzZTogJHtlcnJvci5lcnJvci5jYXVzZX1gO1xuXG4gICAgICAgICAgICB0aXRsZSA9IGVycm9yLmVycm9yLnRpdGxlO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBnZW5lcmljRXJyb3IgPSB0aGlzLmdlbmVyaWNFcnJvclNlcnZpY2UuZ2V0RXJyb3JCeUNvZGUoZXJyb3IpO1xuXG4gICAgICAgICAgICBmdWxsTWVzc2FnZSA9IGBYLUNvcnJlbGF0aW9uLUlEOiAke2Vycm9ySWR9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6ICR7Y3JlYXRlZEF0fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiAke2Vycm9yLnN0YXR1c31cbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJHtlcnJvci51cmx9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5OiAke2dlbmVyaWNFcnJvci5kZXRhaWx9YDtcblxuICAgICAgICAgICAgdGl0bGUgPSBnZW5lcmljRXJyb3IudGl0bGU7XG4gICAgICAgIH1cblxuICAgICAgICBuYW1lZEVycm9yID0ge1xuICAgICAgICAgICAgbWVzc2FnZTogdGl0bGUsXG4gICAgICAgICAgICBjcmVhdGVkQXQ6IGNyZWF0ZWRBdCxcbiAgICAgICAgICAgIGNvcnJlbGF0aW9uSWQ6IGVycm9ySWQsXG4gICAgICAgICAgICBmdWxsTWVzc2FnZTogZnVsbE1lc3NhZ2VcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gbmFtZWRFcnJvcjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNZXRvZG8gcmVzcG9uc8OhdmVsIHBvciBvYnRlciBvIGlkZW50aWZpY2Fkb3IgZG8gZXJyb1xuICAgICAqIEBwcml2YXRlIFxuICAgICAqIEBwYXJhbSB7SHR0cEVycm9yUmVzcG9uc2V9IGVycm9yXG4gICAgICogQHJldHVybnMgc3RyaW5nXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZXRFcnJvcklkKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSk6IHN0cmluZyB7XG4gICAgICAgIGxldCBlcnJvcktleTogc3RyaW5nIHwgbnVsbDtcblxuICAgICAgICBlcnJvci5oZWFkZXJzLmtleXMoKS5ldmVyeShrZXkgPT4ge1xuICAgICAgICAgICAgaWYgKGtleS50b1VwcGVyQ2FzZSgpID09PSAnWC1DT1JSRUxBVElPTi1JRCcpIHtcbiAgICAgICAgICAgICAgICBlcnJvcktleSA9IGtleTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGVycm9yS2V5ID8gZXJyb3IuaGVhZGVycy5nZXQoZXJyb3JLZXkpIDogbnVsbDtcbiAgICB9XG5cbn1cbiJdfQ==